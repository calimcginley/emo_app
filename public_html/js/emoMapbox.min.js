var map;var hexLayer;var markers;var setViewLat;var setViewLong;window.localStorage.setItem("hex-are","on");var emoFilterArray=["1","2","3","4","5","6","7","8"];var filterOpen=false;var onSuccess=function(a){setViewLat=a.coords.latitude;window.localStorage.setItem("postLat",setViewLat);setViewLong=a.coords.longitude;window.localStorage.setItem("postLong",setViewLong);console.log("geo local success lat is "+setViewLat+" and long is "+setViewLong);setMapInAction()};function onError(a){setViewLat="52.341";window.localStorage.setItem("postLat",setViewLat);setViewLong="-5.27";window.localStorage.setItem("postLong",setViewLong);console.log("Geo local fail lat is "+setViewLat+" and long is "+setViewLong);setMapInAction()}navigator.geolocation.getCurrentPosition(onSuccess,onError);function setMapInAction(){console.log("At mapbox stage the lat is "+setViewLat+" and long is "+setViewLong);map=L.mapbox.map("map","emomcginley.jmmf7jce",{zoomControl:false,detectRetina:true,maxZoom:17}).setView([setViewLat,setViewLong],14);L.HexbinLayer=L.Class.extend({includes:L.Mixin.Events,initialize:function(b,a){this.levels={};this.layout=d3.hexbin().radius(22);this.rscale=d3.scale.sqrt().range([0,22]).clamp(true);this.rwData=b;this.config=a},project:function(b){var a=this.map.latLngToLayerPoint([b[1],b[0]]);return[a.x,a.y]},getBounds:function(c){var a=d3.geo.bounds(c);return L.bounds(this.project([a[0][0],a[1][1]]),this.project([a[1][0],a[0][1]]))},update:function(){var c=10,b=this.getBounds(this.rwData),a=this.map.getZoom();this.container.attr("width",b.getSize().x+(2*c)).attr("height",b.getSize().y+(2*c)).style("margin-left",(b.min.x-c)+"px").style("margin-top",(b.min.y-c)+"px");var d=window.localStorage.getItem("hex-are");if(d==="on"){if(!(a in this.levels)){this.levels[a]=this.container.append("g").attr("class","zoom-"+a);this.genHexagons(this.levels[a]);this.levels[a].attr("transform","translate("+-(b.min.x-c)+","+-(b.min.y-c)+")")}if(this.curLevel){this.curLevel.style("display","none")}this.curLevel=this.levels[a];this.curLevel.style("display","inline")}else{if(!(a in this.levels)){this.levels[a]=this.container.append("g").attr("class","zoom-"+a);this.genHexagons(this.levels[a]);this.levels[a].attr("transform","translate("+-(b.min.x-c)+","+-(b.min.y-c)+")")}if(this.curLevel){this.curLevel.style("display","none")}this.curLevel=this.levels[a];this.curLevel.style("display","none")}},genHexagons:function(a){var e=this.rwData.features.map(function(h){var g=this.project(h.geometry.coordinates);return[g[0],g[1],h.properties]},this);var d=this.layout(e);var c=a.selectAll(".hexagon").data(d);var b=[];d.map(function(g){b.push(g.length)});this.rscale.domain([0,(ss.mean(b)+(ss.standard_deviation(b)*3))]);var f=c.enter().append("path").attr("class","hexagon");this.config.style.call(this,f);that=this;c.attr("d",function(g){return that.layout.hexagon(that.rscale(g.length))}).attr("transform",function(g){return"translate("+g.x+","+g.y+")"}).on("click",function(g){map.on("click",function(h){if(map.getZoom()<=16){map.setView([h.latlng.lat,h.latlng.lng],map.getZoom()+2);$("#zoomLevel").html("The level is"+map.getZoom())}else{$(this).addClass(".animateHexagon")}})})},addTo:function(a){a.addLayer(this);return this},onAdd:function(a){this.map=a;var b=this.map.getPanes().overlayPane;if(!this.container||b.empty){this.container=d3.select(b).append("svg").attr("id","hex-svg").attr("class","leaflet-layer leaflet-zoom-hide emotionHexbin")}a.on({moveend:this.update},this);this.update()}});L.hexbinLayer=function(b,a){return new L.HexbinLayer(b,a)};window.setJsonLayers=function(){$("#hex-svg").remove();console.log("getJSONMarkerData() is running ...");var a="";var d="";$.each(emoFilterArray,function(e,f){if(e===(emoFilterArray.length-1)){d=d+f}else{d=d+f+"|"}});console.log("The REGEXP string is now:");console.log(d);var c="http://www.emoapp.info/php/mysql_points_geojson_sensus.php?emoTypes=%27"+d+"%27";console.log("The PHP url is now:");console.log(c);d3.json(c,function(e){console.log("geoData - - - - -  - ");console.log(e);hexLayer=L.hexbinLayer(e,{style:f}).addTo(map);function f(g){console.log("hexbin style start - - - - - - -");g.attr("stroke","black").attr("fill",function(l){var h={"0":"rgba(251, 237, 40, 0.9)","1":"#69CBE1","2":"#A554A0","3":"#64BC45","4":"#E10686","5":"#69CBE1","6":"#C32026","7":"#F5851F"};var k=[0,0,0,0,0,0,0,0];$.each(l,function(m,n){var o=n[2].emoType-1;k[o]++});var j=Math.max.apply(null,k);var i=$.inArray(j,k);if(i===-1){return h[0]}else{return h[i]}})}});markers=new L.MarkerClusterGroup({spiderfyDistanceMultiplier:3,removeOutsideVisibleBounds:true,spiderfyOnMaxZoom:true});$.getJSON(c,function(e){$.each(e.features,function(i,k){var j=L.icon({iconUrl:"images/svgPins/pin"+k.properties.emoType+".svg",iconSize:[45,60],iconAnchor:[22,60],shadowUrl:"images/svgPins/Pin_shadow.svg",shadowSize:[73,46],shadowAnchor:[41,46]});var f=k.geometry.coordinates.toString();var h=f.split(",");var g=L.marker([h[1],h[0]],{title:k.properties.postID,icon:j});markers.addLayer(g)})});markers.on("click",function(g){console.log("Existing Marker Clicked");console.log("Exisitng Marker Clicked: Function");console.log(g.layer.options.title);var f=g.layer.options.title;console.log("Exisitng Marker was clicked - postID: "+f);map.setView(g.layer.getLatLng());markerClicked(f)});map.on("zoomend",b);function b(){var e=map.getZoom();console.log("Map zoom is "+e);if(e>=14){$(".emotionHexbin").hide();window.localStorage.setItem("hex-are","off");console.log("hex hidden?, show markers");map.addLayer(markers)}else{map.removeLayer(markers);$(".emotionHexbin").show();window.localStorage.setItem("hex-are","on");var f=map.getZoom();console.log("zoom is"+f);console.log("SHow Hex, hide Pins");$(".zoom-"+f).show()}}};setJsonLayers();window.setInterval(function(){if($.mobile.activePage.attr("id")==="mapPage"){setJsonLayers()}},60000);$(document).on("pageshow","#mapPage",function(){console.log("Invalidate the map size");map.invalidateSize()})}function markerClicked(a){$.ajax({url:"http://emoapp.info/php/getMarkerInfo.php",data:{action:"markerPost",postID:a},type:"post",async:"true",beforeSend:function(){$.mobile.loading("show",{text:"Fetching Emotion Data",textVisible:true})},complete:function(){$.mobile.loading("hide")},success:function(b){console.log("Map Marker Fetch Succesfull");console.log($.trim(b));console.log(b.status);var c="http://emoapp.info/uploads/"+$.trim(b)+".jpg";console.log("The image src is : "+c);$("#emoPostPopup").attr("src",c);$("#mapPage").addClass("show-popup");$("#emojiSearchBar").velocity({top:"-100%",easing:"easein"},500);$("#emojiPostSelectParent").velocity({left:"-100%",easing:"easein"},500)},error:function(c,b){console.log("error = "+b);console.log("XMLHttpRequest",XMLHttpRequest)}})}function addMarkerToMap(b,a,e,f){console.log("The values passed to addMarkerToMap: EmoType-"+b+" PostID-"+a+" LatLong-"+e+f);var c;var d=L.icon({iconUrl:"images/svgPins/animated/pin"+b+".svg",iconRetinaUrl:"images/svgPins/animated/pin"+b+".svg",iconSize:[76,80],iconAnchor:[36,80],popupAnchor:[-3,-31],shadowUrl:"images/svgPins/animated/Pin_shadow.svg",shadowRetinaUrl:"images/svgPins/animated/Pin_shadow.svg",shadowSize:[73,46],shadowAnchor:[41,46]});var c=L.marker([e,f],{title:a,icon:d});c.on("click",function(){console.log("New Marker Clicked");console.log("New Marker Clicked: Function");console.log("Post ID is: "+a);console.log("New Marker was clicked - postID: "+a);markerClicked(a)});markers.addLayer(c)}function centerMap(a,b){console.log("centered map view");map.setView([a,b])}function mapSetView(a,b){console.log("setting mao view");map.setView([a,b],15)}$(document).on("pageshow","#mapPage",function(){$(".emoFilterBtn").click(function(){console.log("Filter Clicked");var d=$.mobile.activePage.attr("id");console.log("pageID: "+d);if(d==="mapPage"){$("#"+d).removeClass("show-menu");isOpen=!isOpen;console.log("close menu");e()}else{console.log("Change to map page and open filter");$(":mobile-pagecontainer").pagecontainer("change","#mapPage",{transition:"slide"});e()}function e(){console.log("Open Filter bar");$("#emojiSearchBar").velocity({top:"100px",easing:"easein"},500);$("#emojiPostSelectParent").velocity({left:"-100%",easing:"easein"},500);filterOpen=!filterOpen}});$(".emojiFilter").on("click",function(){console.log("Filter clicked");var d=$(this).attr("data-name");if($(this).hasClass("filterOff")){emoFilterArray.push(d);$(this).removeClass("filterOff")}else{$(this).addClass("filterOff");$("#checkboxSelectAll").prop("checked",false).checkboxradio("refresh");emoFilterArray=jQuery.grep(emoFilterArray,function(e){return e!==d})}console.log("The emoType Array is now:");console.log(emoFilterArray)});$("#checkboxSelectAll").on("click",function(){if($("#checkboxSelectAll").prop("checked")){$(".emojiFilter").removeClass("filterOff");emoFilterArray=["1","2","3","4","5","6","7","8"]}else{$(".emojiFilter").addClass("filterOff");emoFilterArray=[]}});$("#filterButton").bind("click",function(d,e){console.log("Filter Button Clicked");$("#emojiSearchBar").velocity({top:"-100%",easing:"easein"},500);filterOpen=!filterOpen;setJsonLayers()});var b=new Date();var c=b.getMonth()+1;var a=b.getFullYear()+"-"+c+"-"+b.getDate()+" "+b.getHours()+":"+b.getMinutes()+":00";console.log(a);$("#dtBox").DateTimePicker({defaultDate:a,titleContentDateTime:"Set Date & Time",dateTimeFormat:"dd-MM-yyyy HH:mm:ss",maxDate:a});$("#timeSpan input[type=radio]").change(function(){var e=$(this).val();var d=$("#timeSlider");if(e==="hour"){d.attr("max",23);d.attr("value",8);$("#timeSlider").slider("refresh")}else{if(e==="day"){d.attr("max",6);d.attr("value",3);$("#timeSlider").slider("refresh")}else{d.attr("max",4);d.attr("value",2);$("#timeSlider").slider("refresh")}}})});